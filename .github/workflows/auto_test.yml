name: Generally auto test apps

on:
  push:
    branches: [main]
    paths:
      - "apps/*/.env"
      - "apps/*/docker-compose.yml"

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    env:
      TAGS: latest
    steps:
      - uses: actions/checkout@v2
        name: Check out code

      - name: set appname
        run: |
          changefile=$(curl \
                         -H "Accept: application/vnd.github+json" \
                         -H "Authorization: Bearer ${{github.token}}" \
                         https://api.github.com/repos/Websoft9/docker-library/compare/${{github.event.before}}...${{github.event.after}} | jq '.files[].filename' | sed 's/\"//g')
          declare -a appnames
          for name in ${changefile};do
              echo ${name}
              app=$(echo ${name} | cut -d "/" -f 2)
              file=$(echo ${name} | cut -d "/" -f 3)
              if [[ ${file} == ".env" ]] || [[ ${file} == "dockercompose.yml" ]];then
                  if [[ ! " ${appnames[@]} " =~ " ${app} " ]]; then
                      appnames+=(${app})
                  fi
              else
                  echo "affect nothing";
              fi
          done
          
          docker network create websoft9
          ls -la
          for appname in ${appnames[@]}; do
            docker-compose -f apps/${appname}/docker-compose.yml up -d
            sleep 30  # Wait for the service to start
            docker ps
            env_file="apps/${appname}/.env"
            if [ -f "$env_file" ]; then
                W9_HTTP_PORT_SET=$(grep W9_HTTP_PORT_SET $env_file | cut -d '=' -f2)
                if [ -z "$W9_HTTP_PORT_SET" ]; then
                    echo "It is not web app";
                else
                    for i in {1..3}
                    do
                        echo "Attempt $i"
                        response=$(curl -L --silent --connect-timeout 15 --output /dev/null --write-out '%{http_code}' localhost:$W9_HTTP_PORT_SET 2>/dev/null)
                        if [ "$response" -eq 200 ]; then
                            echo "Successfully connected to localhost:$W9_HTTP_PORT_SET"
                            break
                        else
                            echo "Cannot connect to localhost:$W9_HTTP_PORT_SET, waiting for 10 seconds before retrying"
                            sleep 10
                        fi    
                    done
                    output=$(curl -L --silent localhost:$W9_HTTP_PORT_SET)
                    if echo "$output" | grep -q "Failed"; then
                      echo "${appname}: can not access" >> /tmp/output
                    else
                      echo "${appname}: can access" >> /tmp/output
                    fi
                    docker ps
                    docker-compose -f apps/${appname}/docker-compose.yml down -v
                fi
            else
                echo "$env_file does not exist";
            fi
          done
          cat /tmp/output
